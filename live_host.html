<!DOCTYPE html>
<html lang="pa">
  <head>
    <meta charset="UTF-8" />
    <title>Live Quiz - Teacher Host</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Laila:wght@400;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <script src="data.js"></script>
    <script src="quizzes.js"></script>
    <style>
      body {
        font-family: "Noto Sans Devanagari", system-ui, sans-serif;
      }
      .font-laila {
        font-family: "Laila", "Noto Sans Devanagari", serif;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-sky-50 via-white to-indigo-50 min-h-screen text-slate-900">
    <!-- Login / password gate -->
    <div
      id="host-login"
      class="min-h-screen flex items-center justify-center px-4 py-8"
    >
      <div
        class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-indigo-100 p-7 relative overflow-hidden"
      >
        <div
          class="absolute -right-10 -top-10 w-32 h-32 bg-indigo-100 rounded-full opacity-40 blur-2xl"
        ></div>
        <div
          class="absolute -left-10 bottom-0 w-28 h-28 bg-purple-100 rounded-full opacity-40 blur-2xl"
        ></div>

        <div class="relative">
          <div class="flex items-center gap-3 mb-4">
            <div
              class="w-11 h-11 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg"
            >
              <span class="material-symbols-outlined text-white text-2xl">
                cast_for_education
              </span>
            </div>
            <div>
              <h1 class="text-2xl font-extrabold text-indigo-700 font-laila leading-snug">
                MathLit Live Quiz (Teacher)
              </h1>
              <p class="text-xs text-slate-500 mt-1">
                ‡®á‡®π ‡®∏‡®ø‡®∞‡®´‡®º ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï / ‡®ê‡®°‡®Æ‡®ø‡®® ‡®≤‡®à ‡®π‡©à‡•§ ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®ó‡©Å‡®™‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®≠‡®∞‡©ã‡•§
              </p>
            </div>
          </div>

          <form id="host-login-form" class="space-y-4 mt-3">
            <div>
              <label
                class="block text-xs font-bold text-slate-700 mb-1 flex items-center gap-1"
              >
                <span class="material-symbols-outlined text-sm">key</span>
                ‡®™‡®æ‡®∏‡®µ‡®∞‡®° (Password)
              </label>
              <input
                type="password"
                id="host-password"
                class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                autocomplete="off"
              />
            </div>

            <p
              id="host-error"
              class="text-xs text-rose-600 font-medium hidden"
            >
              ‚ùå ‡®ó‡®≤‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®°‡•§ ‡®¶‡©Å‡®¨‡®æ‡®∞‡®æ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§
            </p>

            <button
              type="submit"
              class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm py-2.5 rounded-xl shadow-md transition"
            >
              <span class="material-symbols-outlined text-base">login</span>
              <span>Host ‡®∏‡®ï‡®∞‡©Ä‡®® ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã</span>
            </button>

            <p class="text-[10px] text-slate-400 mt-3 leading-relaxed">
              üîí ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®∏‡®∞‡®µ‡®∞ '‡®§‡©á ‡®∏‡©à‡©±‡®ü ‡®π‡©Å‡©∞‡®¶‡®æ ‡®π‡©à (QUIZ_ADMIN_PASSWORD env var ‡®¶‡©Ä ‡®µ‡®∞‡®§‡©ã‡®Ç ‡®®‡®æ‡®≤)‡•§
            </p>
          </form>
        </div>
      </div>
    </div>

    <!-- Main host UI (hidden until password correct) -->
    <div id="host-main" class="hidden">
      <div class="max-w-5xl mx-auto p-4 md:p-6">
        <header class="mb-5 flex items-center justify-between gap-3 bg-white/70 backdrop-blur border border-slate-100 rounded-2xl px-3 py-2 shadow-sm">
          <div class="flex items-center gap-3">
            <div
              class="w-11 h-11 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg"
            >
              <span class="material-symbols-outlined text-white text-2xl">
                cast_for_education
              </span>
            </div>
            <div>
              <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700 font-laila">
                MathLit Live Quiz (Teacher)
              </h1>
              <p class="text-xs md:text-sm text-slate-600">
                Kahoot-style ‡®ï‡®µ‡©Ä‡®ú‡®º ‚Ä¢ Students join with code ‚Ä¢ Live leaderboard
              </p>
            </div>
          </div>
          <a
            href="index.html"
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl text-xs md:text-sm font-semibold border border-indigo-200 bg-white hover:bg-indigo-50 text-indigo-700 shadow-sm"
          >
            <span class="material-symbols-outlined text-base"> home </span>
            ‡®Æ‡©Å‡©±‡®ñ ‡®∏‡®´‡®º‡®æ
          </a>
        </header>

        <!-- Setup panel -->
        <section
          id="setup-panel"
          class="bg-white border border-indigo-100 rounded-2xl shadow-md p-4 md:p-5 mb-5"
        >
          <h2 class="text-base md:text-lg font-bold text-slate-800 mb-3 font-laila">
            1Ô∏è‚É£ ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®∏‡©à‡©±‡®ü ‡®ï‡®∞‡©ã (Setup Quiz)
          </h2>
          <div class="grid md:grid-cols-3 gap-4 text-sm">
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-600">
                ‡®ú‡®Æ‡®æ‡®§ (Class)
              </label>
              <select
                id="host-class-select"
                class="w-full border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
              ></select>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-600">
                ‡®™‡®æ‡®† (Chapter)
              </label>
              <select
                id="host-chapter-select"
                class="w-full border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
              ></select>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-600">
                ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®®‡®æ‡®Æ (Teacher name)
              </label>
              <input
                id="host-name-input"
                type="text"
                class="w-full border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Teacher ji"
              />
            </div>
          </div>
          <button
            id="btn-create-game"
            class="mt-4 inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold px-4 py-2.5 rounded-xl shadow-md transform transition hover:scale-[1.02]"
          >
            <span class="material-symbols-outlined text-base"> play_arrow </span>
            Live Quiz ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã (Create Game)
          </button>
          <p id="setup-error" class="mt-2 text-xs text-rose-600 hidden"></p>
        </section>

        <!-- Game panel -->
        <section
          id="game-panel"
          class="hidden bg-white border border-emerald-100 rounded-2xl shadow-lg p-4 md:p-5"
        >
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <div>
              <p class="text-xs text-slate-500">Join Code</p>
              <div class="flex items-baseline gap-3">
                <span
                  id="game-code-display"
                  class="text-3xl md:text-4xl font-extrabold tracking-[0.35em] text-emerald-600"
                >
                  000000
                </span>
                <button
                  id="btn-copy-code"
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100"
                >
                  <span class="material-symbols-outlined text-sm">content_copy</span>
                  ‡®ï‡®æ‡®™‡©Ä
                </button>
              </div>
              <p class="text-[11px] text-slate-500 mt-1">
                ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®Ü‡®™‡®£‡©á ‡®Æ‡©ã‡®¨‡®æ‡®à‡®≤/PC '‡®§‡©á <code>/live_join</code> ‡®ñ‡©ã‡®≤‡©ç‡®π ‡®ï‡©á ‡®á‡®π ‡®ï‡©ã‡®° ‡®≠‡®∞‡®®‡®ó‡©á
              </p>
            </div>

            <div class="text-xs text-right space-y-1">
              <p>
                ‡®ú‡®Æ‡®æ‡®§:
                <span id="label-class" class="font-semibold text-indigo-700"></span>
              </p>
              <p>
                ‡®™‡®æ‡®†:
                <span id="label-chapter" class="font-semibold text-indigo-700"></span>
              </p>
              <p>
                ‡®ï‡©Å‡©±‡®≤ ‡®∏‡®µ‡®æ‡®≤:
                <span id="label-total-questions" class="font-semibold text-slate-700"></span>
              </p>
            </div>
          </div>

          <div class="grid md:grid-cols-[2fr,1.5fr] gap-4">
            <!-- Question viewer -->
            <div
              class="border border-slate-200 rounded-2xl p-4 bg-slate-50/80 flex flex-col min-h-[260px] shadow-sm"
            >
              <div class="flex items-center justify-between mb-2 text-xs">
                <span class="font-semibold text-slate-600">
                  ‡®∏‡®µ‡®æ‡®≤
                  <span id="label-question-index" class="text-indigo-700">0</span>
                  /
                  <span id="label-question-total" class="text-slate-700">0</span>
                </span>
                <span id="label-game-status" class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700">
                  Waiting for players...
                </span>
              </div>
              <div class="flex-1">
                <p
                  id="host-question-text"
                  class="text-lg md:text-xl font-bold text-slate-900 font-laila mb-3 min-h-[60px]"
                >
                  ‚Äî
                </p>
                <ol id="host-options-list" class="space-y-1 text-sm"></ol>
              </div>
              <div class="mt-3 flex items-center justify-between">
                <button
                  id="btn-prev-q"
                  class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300 disabled:opacity-40"
                >
                  ‚Üê ‡®™‡®ø‡®õ‡®≤‡®æ
                </button>
                <button
                  id="btn-next-q"
                  class="px-4 py-1.5 rounded-xl text-xs font-semibold transform transition hover:scale-[1.02] bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40"
                >
                  ‡®Ö‡©±‡®ó‡®≤‡®æ ‡®∏‡®µ‡®æ‡®≤ ‚Üí
                </button>
                <button
                  id="btn-end-game"
                  class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-rose-600 text-white hover:bg-rose-700"
                >
                  ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®ñ‡®§‡®Æ ‡®ï‡®∞‡©ã
                </button>
              </div>
            </div>

            <!-- Leaderboard -->
            <div class="border border-slate-200 rounded-2xl p-4 bg-white/90 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base text-amber-500">
                    leaderboard
                  </span>
                  ‡®≤‡©Ä‡®°‡®∞‡®¨‡©ã‡®∞‡®°
                </h3>
                <span
                  id="label-player-count"
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700"
                >
                  0 players
                </span>
              </div>
              <ul id="leaderboard-list" class="space-y-1 text-sm max-h-64 overflow-y-auto"></ul>
              <p
                id="leaderboard-empty"
                class="text-xs text-slate-500 text-center mt-4"
              >
                ‡®π‡®æ‡®≤‡©á ‡®ï‡©ã‡®à ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®ú‡©Å‡©ú‡®ø‡®Ü‡•§
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Host-side JS for live quiz (Kahoot-style)

      // Expect CLASSES global from data.js if available, otherwise fall back to CLASS_7_DATA only
      function getAllClasses() {
        if (typeof CLASSES !== "undefined") {
          return CLASSES;
        }
        // fallback basic object
        return {
          CLASS_7: CLASS_7_DATA,
        };
      }

      const classesMap = getAllClasses();

      const classSelect = document.getElementById("host-class-select");
      const chapterSelect = document.getElementById("host-chapter-select");
      const hostNameInput = document.getElementById("host-name-input");
      const btnCreate = document.getElementById("btn-create-game");
      const setupError = document.getElementById("setup-error");

      const setupPanel = document.getElementById("setup-panel");
      const gamePanel = document.getElementById("game-panel");

      const gameCodeDisplay = document.getElementById("game-code-display");
      const btnCopyCode = document.getElementById("btn-copy-code");
      const labelClass = document.getElementById("label-class");
      const labelChapter = document.getElementById("label-chapter");
      const labelTotalQuestions = document.getElementById("label-total-questions");
      const labelQuestionIndex = document.getElementById("label-question-index");
      const labelQuestionTotal = document.getElementById("label-question-total");
      const labelStatus = document.getElementById("label-game-status");
      const labelPlayerCount = document.getElementById("label-player-count");
      const leaderboardList = document.getElementById("leaderboard-list");
      const leaderboardEmpty = document.getElementById("leaderboard-empty");

      const btnPrevQ = document.getElementById("btn-prev-q");
      const btnNextQ = document.getElementById("btn-next-q");
      const btnEndGame = document.getElementById("btn-end-game");

      const qText = document.getElementById("host-question-text");
      const qOptionsList = document.getElementById("host-options-list");

      let currentGame = null; // {gameCode, hostToken, classId, chapterId}
      let currentQuestions = [];
      let currentIndex = -1;

      function initClassAndChapters() {
        Object.keys(classesMap).forEach((key) => {
          const cls = classesMap[key];
          const opt = document.createElement("option");
          opt.value = cls.id || key;
          opt.textContent = cls.name || key;
          classSelect.appendChild(opt);
        });

        classSelect.addEventListener("change", () => {
          populateChapters();
        });

        populateChapters();
      }

      function populateChapters() {
        chapterSelect.innerHTML = "";
        const selectedClassId = classSelect.value || Object.values(classesMap)[0].id;
        let clsObj = null;
        Object.keys(classesMap).forEach((key) => {
          const c = classesMap[key];
          if (c.id === selectedClassId || key === selectedClassId) {
            clsObj = c;
          }
        });
        if (!clsObj) {
          clsObj = Object.values(classesMap)[0];
        }

        (clsObj.chapters || []).forEach((ch) => {
          const opt = document.createElement("option");
          opt.value = ch.id;
          opt.textContent = ch.name;
          chapterSelect.appendChild(opt);
        });
      }

      function findClassObjById(classId) {
        let found = null;
        Object.keys(classesMap).forEach((k) => {
          const c = classesMap[k];
          if (c.id === classId || k === classId) {
            found = c;
          }
        });
        return found || Object.values(classesMap)[0];
      }

      function findChapterObj(classId, chapterId) {
        const cls = findClassObjById(classId);
        if (!cls || !cls.chapters) return null;
        return cls.chapters.find((ch) => ch.id === chapterId) || null;
      }

      async function createGame() {
        setupError.classList.add("hidden");
        const classId = classSelect.value;
        const chapterId = chapterSelect.value;
        const hostName = hostNameInput.value.trim() || "Teacher";
        const adminToken = sessionStorage.getItem("liveQuizHostToken");

        if (!adminToken) {
          setupError.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®®‡®æ‡®≤ ‡®≤‡©ã‡®ó‡®á‡®® ‡®ï‡®∞‡©ã‡•§";
          setupError.classList.remove("hidden");
          return;
        }

        if (!classId || !chapterId) {
          setupError.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®Ö‡®§‡©á ‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã‡•§";
          setupError.classList.remove("hidden");
          return;
        }

        try {
          btnCreate.disabled = true;
          btnCreate.textContent = "Creating game...";

          const resp = await fetch("/api/live/create_game", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ classId, chapterId, hostName, adminToken }),
          });
          const data = await resp.json();
          if (!data.ok) {
            throw new Error(data.error || "Failed to create game");
          }

          const gameCode = data.gameCode;
          const hostToken = data.hostToken;
          currentGame = { gameCode, hostToken, classId, chapterId };

          // Prepare questions from QUIZZES (segregated quiz data)
          const chapter = findChapterObj(classId, chapterId);
          let questions = [];
          if (
            typeof QUIZZES !== "undefined" &&
            QUIZZES[classId] &&
            QUIZZES[classId][chapterId]
          ) {
            questions = QUIZZES[classId][chapterId];
          }

          currentQuestions = Array.isArray(questions) ? questions : [];
          currentIndex = -1;

          if (!currentQuestions.length) {
            setupError.textContent = "‡®á‡®∏ ‡®Ö‡®ß‡®ø‡®Ü‡®á ‡®≤‡®à ‡®ï‡©ã‡®à ‡®ï‡®µ‡®ø‡®ú ‡®∏‡®µ‡®æ‡®≤ ‡®®‡®π‡©Ä‡®Ç ‡®Æ‡®ø‡®≤‡©á‡•§";
            setupError.classList.remove("hidden");
            return;
          }

          showGameUI();
          startPollingState();
        } catch (err) {
          console.error(err);
          setupError.textContent = "Game ‡®¨‡®£‡®æ‡®â‡®Ç‡®¶‡©á ‡®∏‡®Æ‡©á‡®Ç ‡®ó‡©ú‡®¨‡©ú ‡®π‡©ã‡®à‡•§";
          setupError.classList.remove("hidden");
        } finally {
          btnCreate.disabled = false;
          btnCreate.textContent = "Live Quiz ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã (Create Game)";
        }
      }

      function showGameUI() {
        if (!currentGame) return;
        setupPanel.classList.add("hidden");
        gamePanel.classList.remove("hidden");

        const cls = findClassObjById(currentGame.classId);
        const chapter = findChapterObj(currentGame.classId, currentGame.chapterId);

        gameCodeDisplay.textContent = currentGame.gameCode;
        labelClass.textContent = cls ? cls.name : currentGame.classId;
        labelChapter.textContent = chapter ? chapter.name : currentGame.chapterId;
        labelTotalQuestions.textContent = currentQuestions.length;
        labelQuestionTotal.textContent = currentQuestions.length;

        updateQuestionView();
      }

      function updateQuestionView() {
        if (!currentQuestions.length) {
          qText.textContent = "No questions found for this chapter.";
          qOptionsList.innerHTML = "";
          btnPrevQ.disabled = true;
          btnNextQ.disabled = true;
          return;
        }

        if (currentIndex < 0) {
          labelQuestionIndex.textContent = "0";
          qText.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á '‡®Ö‡©±‡®ó‡®≤‡®æ ‡®∏‡®µ‡®æ‡®≤' ‡®¶‡®¨‡®æ ‡®ï‡©á ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã‡•§";
          qOptionsList.innerHTML = "";
          btnPrevQ.disabled = true;
          return;
        }

        const q = currentQuestions[currentIndex];
        labelQuestionIndex.textContent = String(currentIndex + 1);
        qText.textContent = q.t;
        qOptionsList.innerHTML = "";
        q.o.forEach((opt, idx) => {
          const li = document.createElement("li");
          li.textContent = `${idx + 1}. ${opt}`;
          li.className =
            "px-2 py-1 rounded-lg bg-white border border-slate-200 text-slate-700 text-sm";
          if (idx === q.c) {
            li.classList.add("border-emerald-400", "bg-emerald-50");
          }
          qOptionsList.appendChild(li);
        });

        btnPrevQ.disabled = currentIndex <= 0;
        btnNextQ.disabled = currentIndex >= currentQuestions.length - 1;
      }

      async function goToQuestion(newIndex) {
        if (!currentGame) return;
        if (newIndex < 0 || newIndex >= currentQuestions.length) return;
        currentIndex = newIndex;
        updateQuestionView();

        const q = currentQuestions[currentIndex];
        try {
          labelStatus.textContent = "Question live for students...";
          await fetch("/api/live/next_question", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              gameCode: currentGame.gameCode,
              hostToken: currentGame.hostToken,
              questionIndex: currentIndex,
              correctIndex: q.c,
            }),
          });
        } catch (err) {
          console.error("Failed to update question on server", err);
        }
      }

      async function endGame() {
        if (!currentGame) return;
        try {
          await fetch("/api/live/end_game", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              gameCode: currentGame.gameCode,
              hostToken: currentGame.hostToken,
            }),
          });
          labelStatus.textContent = "Quiz finished.";
        } catch (err) {
          console.error("Failed to end game", err);
        }
      }

      async function pollStateOnce() {
        if (!currentGame) return;
        try {
          const resp = await fetch(
            `/api/live/state?gameCode=${encodeURIComponent(currentGame.gameCode)}`
          );
          const data = await resp.json();
          if (!data.ok) return;

          // Update game status text
          labelStatus.textContent =
            data.status === "waiting"
              ? "Waiting for players..."
              : data.status === "in_progress"
              ? "Question live."
              : "Finished.";

          // Update leaderboard
          const players = data.players || [];
          labelPlayerCount.textContent = `${players.length} players`;
          leaderboardList.innerHTML = "";
          if (!players.length) {
            leaderboardEmpty.classList.remove("hidden");
          } else {
            leaderboardEmpty.classList.add("hidden");
            players.forEach((p, idx) => {
              const li = document.createElement("li");
              li.className =
                "flex items-center justify-between px-3 py-1.5 rounded-xl bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200";
              li.innerHTML = `
                <span class="flex items-center gap-2">
                  <span class="text-xs font-semibold text-slate-500">#${idx + 1}</span>
                  <span class="font-semibold">${p.name}</span>
                </span>
                <span class="text-xs font-bold text-indigo-700">${p.score}</span>
              `;
              leaderboardList.appendChild(li);
            });
          }
        } catch (err) {
          console.error("Error polling state", err);
        }
      }

      function startPollingState() {
        setInterval(pollStateOnce, 1500);
      }

            // Password gate logic
      (function () {
        const loginView = document.getElementById("host-login");
        const mainView = document.getElementById("host-main");
        const form = document.getElementById("host-login-form");
        const input = document.getElementById("host-password");
        const errorEl = document.getElementById("host-error");

        function unlock() {
          if (!loginView || !mainView) return;
          loginView.classList.add("hidden");
          mainView.classList.remove("hidden");
          // init class/chapter dropdowns once unlocked
          initClassAndChapters();
        }

        async function handleSubmit(e) {
          e.preventDefault();
          const val = (input.value || "").trim();
          if (!val) {
            errorEl.textContent = "‚ùå ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®≠‡®∞‡©ã‡•§";
            errorEl.classList.remove("hidden");
            return;
          }

          try {
            const resp = await fetch("/api/auth/check", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password: val }),
            });
            const data = await resp.json();

            if (data.ok && data.token) {
              sessionStorage.setItem("liveQuizHostAuth", "ok");
              sessionStorage.setItem("liveQuizHostToken", data.token);
              errorEl.classList.add("hidden");
              unlock();
            } else {
              errorEl.textContent = "‚ùå ‡®ó‡®≤‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®°‡•§ ‡®¶‡©Å‡®¨‡®æ‡®∞‡®æ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§";
              errorEl.classList.remove("hidden");
            }
          } catch (err) {
            console.error("Host auth error", err);
            errorEl.textContent =
              "‚ö†Ô∏è ‡®∏‡®∞‡®µ‡®∞ ‡®®‡®æ‡®≤ ‡®ï‡®®‡©à‡®ï‡®∏‡®º‡®® ‡®®‡®π‡©Ä‡®Ç ‡®¨‡®£‡©Ä‡•§ ‡®¨‡®æ‡®Ö‡®¶ ‡®µ‡®ø‡©±‡®ö ‡®´‡®ø‡®∞ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§";
            errorEl.classList.remove("hidden");
          }
        }

        if (form) {
          form.addEventListener("submit", handleSubmit);
        }

        window.addEventListener("load", function () {
          const already = sessionStorage.getItem("liveQuizHostAuth") === "ok" &&
                !!sessionStorage.getItem("liveQuizHostToken");
          if (already) {
            unlock();
          } else if (loginView) {
            loginView.classList.remove("hidden");
          }
        });

        // Attach other event listeners once DOM is ready
        window.addEventListener("load", function () {
          btnCreate.addEventListener("click", createGame);
          btnPrevQ.addEventListener("click", () => goToQuestion(currentIndex - 1));
          btnNextQ.addEventListener("click", () => {
            if (currentIndex < 0) {
              goToQuestion(0);
            } else {
              goToQuestion(currentIndex + 1);
            }
          });
          btnEndGame.addEventListener("click", endGame);

          btnCopyCode.addEventListener("click", () => {
            if (!currentGame) return;
            const text = currentGame.gameCode;

            // Prefer modern clipboard API in secure contexts
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard
                .writeText(text)
                .then(() => {
                  btnCopyCode.textContent = "Copied!";
                  setTimeout(() => (btnCopyCode.textContent = "‡®ï‡®æ‡®™‡©Ä"), 1000);
                })
                .catch(() => {
                  alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
                });
              return;
            }

            // Fallback for http / older browsers
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
              const ok = document.execCommand("copy");
              if (ok) {
                btnCopyCode.textContent = "Copied!";
                setTimeout(() => (btnCopyCode.textContent = "‡®ï‡®æ‡®™‡©Ä"), 1000);
              } else {
                alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
              }
            } catch (e) {
              alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
            } finally {
              document.body.removeChild(textarea);
            }
          });

          // also start polling for state once host page is loaded
          startPollingState();
        });
      })();
    </script>
  </body>
</html>
